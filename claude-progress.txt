# DJ Mix Generator - Progress Tracker
# Update this file regularly. Commit to git for cross-device sync.
# Last updated: 2026-01-03 (iOS + macOS Authentication Fix)

## Current Focus
- [x] v2.0 Deterministic architecture DEPLOYED
- [x] iOS app authentication FIXED (2026-01-03)
- [x] macOS app authentication FIXED (2026-01-03)
- [x] Critical API bug fixed (request body consumption)
- [ ] Apple Music matching in progress (~82%+ complete)

## Recently Completed

### 2026-01-03: iOS + macOS Apps FIXED
- [x] Fixed critical bug: request.json() was called twice (body can only be consumed once)
- [x] Both apps now send refresh_token in request body
- [x] macOS app: fixed response key (playlistURL â†’ playlistUrl)
- [x] Added null check for artist names in selection scoring
- [x] Deployed to Vercel production
- [x] Built and tested macOS app
- [x] Updated all documentation

### 2026-01-01: v2.0 MAJOR ARCHITECTURE OVERHAUL
- [x] Switched from Claude AI selection to deterministic algorithm
- [x] Integrated full Apple Music library (30,000+ tracks)
- [x] Added Apple Music playcount weighting (0-40 points)
- [x] Implemented selection score system
- [x] Added variety enforcement (max 3 tracks per artist)
- [x] Fixed artist filtering bug in playlist-nlp.ts
- [x] Updated all documentation (CLAUDE.md, README.md, HANDOVER-BRIEF.md)

### 2025-12-31: Spotify catalog search implemented
- [x] System now searches ~30 tracks per Include artist from Spotify
- [x] Prioritizes user's liked songs, then popular tracks
- [x] MIK data used for harmonic analysis when available

### 2025-12-31: Architecture review completed
- [x] Identified library-only limitation (was only using 4,080 MIK tracks)
- [x] Fixed Include vs Reference artist handling

## In Progress
- [ ] Apple Music matching: ~40,000/48,474 (~82%)
  - Matcher running in background
  - ~8,500 tracks remaining

## Completed
- [x] Data merge (MIK + Apple Music + Spotify search) - DONE
- [x] Deterministic selection algorithm - DONE
- [x] Variety enforcement - DONE
- [x] iOS native app - DONE
- [x] macOS native app - DONE
- [x] Documentation update - DONE

## Architecture Decisions Log
- 2026-01-03: Native App Authentication
  - Parse request body ONCE (stream can only be consumed once)
  - Accept tokens from request body for native apps
  - Cookies for web app, body tokens for native apps
- 2026-01-01: v2.0 Deterministic Architecture
  - Removed Claude AI from track selection (kept for NLP only)
  - Selection score: playcount + MIK data + constraints + artist match
  - Variety: max 3 tracks per artist, min 10 unique artists
  - Data: MIK (4,080) + Apple Music (40,000+) + Spotify search

## Key URLs
- Production: https://dj-mix-generator.vercel.app
- Vercel Dashboard: (check .vercel/project.json for project ID)

## Session Notes

### 2026-01-03 Session (iOS + macOS Authentication Fix)
- Fixed iOS app "Not authenticated" error
- Root cause: request.json() called twice - body stream consumed on first call
- Solution: Parse body once, extract all fields including tokens
- Also fixed macOS app (was missing refresh_token, wrong response key)
- Deployed to Vercel production
- Built and launched macOS app

Key files changed:
- `app/api/generate-playlist/route.ts` - Parse body once, accept tokens
- `NotoriousDAD-iOS/.../ContentView.swift` - Include refresh_token
- `NotoriousDAD-macOS/.../ContentView.swift` - Include refresh_token, fix playlistUrl key

Git commits:
- d4b4935 - Fix: Parse request body once for tokens + null check for artist names
- de150c0 - Update .vercelignore to exclude node_modules and native apps
- 68ae32f - Fix macOS app: Add refresh_token and fix playlistUrl key

### 2026-01-01 Session (v2.0 Deploy)
- Complete architecture overhaul to deterministic selection
- Fixed artist variety issue (was only showing Include artists)
- Integrated full Apple Music checkpoint (27,632+ and growing)
- Updated all documentation
- Matcher running at 2.1-2.2 tracks/sec
- User asked about Swift native app - consider after web version stable
